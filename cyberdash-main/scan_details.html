<!doctype html>
<html>
<head>
    <title>Scan Details - {{ scan.info.name }}</title>
</head>
<body>
<h1>Scan: {{ scan.info.name }}</h1>
<p>Status: <span id="status" aria-live="polite">{{ scan.info.status }}</span></p>
<button id="refreshBtn">Refresh Status</button>
<button id="exportBtn">Export Scan</button>

<h2>Hosts scanned:</h2>
<ul>
    {% for host in scan.hosts %}
        <li>{{ host.hostname }} - Vulnerabilities: {{ host.vulnerabilities|length }}</li>
    {% endfor %}
</ul>

<script>
const scanId = "{{ scan.info.id }}";  // wrapped in quotes for safety
const refreshBtn = document.getElementById('refreshBtn');
const exportBtn = document.getElementById('exportBtn');
const statusSpan = document.getElementById('status');

refreshBtn.onclick = async () => {
    refreshBtn.disabled = true;
    const originalText = refreshBtn.textContent;
    refreshBtn.textContent = 'Refreshing...';
    try {
        const res = await fetch(`/scan/${scanId}/status`);
        if (!res.ok) throw new Error('Network response was not ok');
        const data = await res.json();
        if (data.status) {
            statusSpan.textContent = data.status;
        } else {
            alert('Error fetching status');
        }
    } catch (err) {
        alert('Failed to fetch status: ' + err.message);
    } finally {
        refreshBtn.disabled = false;
        refreshBtn.textContent = originalText;
    }
};

exportBtn.onclick = async () => {
    exportBtn.disabled = true;
    const originalText = exportBtn.textContent;
    exportBtn.textContent = 'Exporting...';
    try {
        const res = await fetch(`/scan/${scanId}/export`, { method: 'POST' });
        if (!res.ok) throw new Error('Network response was not ok');
        const data = await res.json();
        alert(data.message || data.error);
    } catch (err) {
        alert('Failed to export: ' + err.message);
    } finally {
        exportBtn.disabled = false;
        exportBtn.textContent = originalText;
    }
};
</script>

</body>
</html>

